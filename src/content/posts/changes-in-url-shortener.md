---
title: Changes in url-shortener
date: 2016-12-04T16:09:24+00:00
categories:
  - Development
projects:
  - url-shortener
  - spam-lists

---
[When I introduced my URL shortener project][1], I already had a working version and I thought I only needed to improve its front-end to be able to release the first stable version of the application. I also had some ideas for new features to be added to it.

However, the longer I looked at my code, the more room for improvements I saw. Although I ended up adding some new features, most of the changes I made since then were refactorizations, changes in design and architecture of the application and code style improvements.

In this post, I&#8217;m going to describe some of them.

<!--more-->

## Front-end

I designed the front-end according to rules of responsive web design. Initial CSS styles ensure it looks good on mobile screens, while the styles specified in media queries override the initial styles to adjust the front-end to larger displays.

Here are examples of the current result: the main page [on a mobile][mob] and [on a desktop screen][desk]. A full gallery is available [here][4].

[mob]: http://i.imgur.com/RuRBETe.png
[desk]: http://i.imgur.com/P6xYoWF.png

## New classes for representing, creating and converting aliases

Alias values are no longer represented by a dedicated class &#8211; they are just simple string objects.

[AliasAlphabet][5] partially replaces the old [Alias][6] and [NumeralSystem][7] classes. It represents an ordered set of characters that can appear in valid alias strings and contains methods for creating aliases.

[IntegerAlias][8] class is now the only one responsible for converting between alias strings and their integer representations, as it should have been from the beginning. It no longer just calls methods responsible for the conversion, but contains the code that actually performs it.

Instances of the class depend on instances of `AliasAlphabet` and use them for the conversion. The constructor of `IntegerAlias` class makes sure all the alias strings generated by an instance of `AliasAlphabet` passed to it can be converted to an integer less or equal to the maximum 32 bit signed integer.

The two responsibilities: that of creating an alias value and that of making sure each possible value has a valid integer representation, are now separated. This is good, because the second responsibility is related to storage, while the first is not, and the current design better adheres to the [single responsibility principle][9]. In addition, the current code responsible for generating an alias value is simpler, and each class in the system contains substantial code.

There is only one downside to the current implementation: for some combinations of alias alphabet length and maximum new alias length, there are both aliases of maximum length whose integer values are smaller and larger than maximum value of int32. In current implementation, instances of `AliasAlphabet` configured with maximum new alias length of such values are treated as invalid.

In the previous implementation, the responsibilities of creating a valid alias value and converting it to integer were assigned to `Alias` class. Alias values were first generated as integers, and if only some aliases of given maximum length were valid, that is: their respective integer values were smaller or equal to max int32, the factory simply chose max int32 as the upper limit for random number generator, instead of the maximum integer value of any alias of given length.

The current implementation is not as flexible. I could have changed it, but I decided it wasn&#8217;t a big problem, so I didn&#8217;t do it.

## New way of shortening a URL

Assigning a random alias to a target URL is no longer performed by [an event handler][10]. Instead, the method responsible for creating a new, randomly generated alias &#8211; [AliasAlphabet.create_random][11] &#8211; [is passed as default_value parameter][12] of SQLAlchemy `Column` object representing the alias column in the database.

Previously, both adding a URL object to database session and committing pending changes to the database were performed by the same function: [url_shortener.models.register][13]. These operations have been split: adding a URL object to session and caching it to ensure it is always unique is now performed by [get\_or\_create class method][14] of the [BaseTargetURL class][15] (replacing previously used [ShortenedURL class][16]). The code responsible for it is based on [this recipe][17].

With `BaseTargetURL` class and [commit function][18] (replacing the `register` function) as currently implemented, it is possible to create multiple target URL objects without performing any database insertions and then to commit all of them at once, in one transaction.

In addition, the application never raises any exception when it generates an already existing random alias at least a certain number of times &#8211; instead, the generation is resumed without limit, until it is successful. The number of possible alias values is large enough for such an occurrence to be rare and for the integrity error to be quickly handled in case it finally occurs, so I don&#8217;t think it&#8217;s necessary to inform a user an error has occurred and to ask him to retry.

## Handling homoglyphs

[Homoglyphs][19] are characters and sequences of characters that are similar to each other. In my URL shortener, for each group of homoglyphs I could think of, all characters are treated as identical to each other and are internally represented by just one of them.

This is the case both when generating an alias and receiving a request with an existing one. This prevents mistakes resulting from users mistyping or misremembering potentially confusing characters in aliases &#8211; when someone uses such a mistyped alias, the application treats it just like the actual alias value similar to it. Thanks to this, a short URL with a mistyped alias can still work just like if it was typed in correctly &#8211; otherwise, the application wouldn&#8217;t recognize it and would just display a 404 error page, and the user might not even realize he made a mistake, and even if he suspected it, he would still be forced to look for a correct URL, either by trial and error or by looking it up again.

## Refactoring view functions

A few functions in the `url_shortener.views` module, namely:

  * [render_preview][20]
  * [preview][21]
  * [get_response][22]
  * [redirect_for][23]

were replaced by a single view class: [ShowURL][24]. I think it is a better solution than having four very small functions, with two of them consisting of just a call to another function.

## Adding migrations

I added support for automatic database migrations using [Flask-Migrate][25] package. I thought it would be a useful addition, and it proved to be useful during the whole refactoring process because it included some changes made to the database model, namely: changing the name of the class representing a shortened URL and changing a name of one of its attributes.

## Application factory and dependency injection container

One of the first decisions I made after publishing my last article on the project was refactoring it so that it would use [flask blueprints][26] and an [application factory function][27]. I thought it would improve the architecture of my project by making it more modular and testable, which would be an improvement of the code by itself and would make it easier to extend my application in the future.

The role of application factory is to create instances of `Flask` class representing applications, each of them configured differently.

To be able to have non-global application objects, I had to remove the reliance of my code on a global app instance and its `config` property. Values of configuration options had to be injected not only into instances of classes, but also into functions, including ones representing views.

For a short time I was considering solving it by simply creating all the objects representing services in the factory function and by introducing functions responsible for initialization of views. However, I decided it was better for dependencies to be created and managed automatically by a dependency injection container. I chose to use [Injector][28] because its author already provided [a package][29] integrating it with Flask and adding the possibility of injecting dependencies directly into flask view functions.

There was one problem with my application: some configuration options or application-instance-specific objects were dependencies of class objects. Having classes defined globally, directly in python modules, means that dependencies of the class objects representing them would also have to be shared globally. It was the case with SQLAlchemy model class &#8211; depending on an instance of `AliasAlphabet` &#8211; and a form class depending on a spam/blacklist validator object.

For the model class, the problem could be solved by making it independent of SQLAlchemy and Flask-SQLAlchemy, creating an SQLALchemy `Table` object dynamically for each instance of application and mapping the class to it (like [here][30]). However, I didn&#8217;t like that it would require explicitly doing things that Flask-SQLAlchemy already did automatically, especially since I already implemented migrations using a package that depended on Flask-SQLAlchemy. Instead, I decided to split the model class into a common base class and an application-object-specific class extending it. The second class was to be created dynamically and injected into views as a dependency.

As for the form class, it depends on the validator being added to validators of its URL field. It was impossible (or at least: difficult and requiring modification to internals of WTForms library) to instantiate the field in the constructor of the form class &#8211; it was [necessary to define it as a class attribute][31]. For this reason, the form class needed to be dynamically created per instance of application, too.

Creation of both class objects is managed by separate injector modules, and they are injected into views like any other dependency.

Because Flask-Migrate requires instances of both `Flask` and `flask_sqlalchemy.SQLAlchemy`, my application factory returns both of the objects, not just the instance of Flask application.

## Changing storage mechanism of blacklist and adding a whitelist

I replaced blacklist file with a simpler approach to storage: a host blacklist specified directly in a python config file. My URL shortener uses my [spam-lists library][32], and reading hosts from a text file was a legacy idea I had for this library until I realised that providing support for any specific storage mechanism in the library should not be part of its scope.

I added a whitelist for hosts known to be safe. URLs with such hosts won&#8217;t be tested against the custom and third-party blacklists.

 [1]: {{< relref "introducing-my-url-shortener.md" >}}
 [2]: http://i.imgur.com/RuRBETe.png
 [3]: http://i.imgur.com/P6xYoWF.png
 [4]: http://imgur.com/a/mCU4E
 [5]: https://github.com/piotr-rusin/url-shortener/blob/ee506ab166d3a170ee8790d33f20cf1ee88205a5/url_shortener/domain_and_persistence.py#L35
 [6]: https://github.com/piotr-rusin/url-shortener/blob/2bbcb9bcc97f8226e7d90d201c57933421ee050e/url_shortener/models.py#L97
 [7]: https://github.com/piotr-rusin/url-shortener/blob/2bbcb9bcc97f8226e7d90d201c57933421ee050e/url_shortener/models.py#L31
 [8]: https://github.com/piotr-rusin/url-shortener/blob/ee506ab166d3a170ee8790d33f20cf1ee88205a5/url_shortener/domain_and_persistence.py#L242
 [9]: http://www.oodesign.com/single-responsibility-principle.html
 [10]: https://github.com/piotr-rusin/url-shortener/blob/2bbcb9bcc97f8226e7d90d201c57933421ee050e/url_shortener/event_handlers.py#L18
 [11]: https://github.com/piotr-rusin/url-shortener/blob/ee506ab166d3a170ee8790d33f20cf1ee88205a5/url_shortener/domain_and_persistence.py#L149
 [12]: https://github.com/piotr-rusin/url-shortener/blob/ee506ab166d3a170ee8790d33f20cf1ee88205a5/url_shortener/domain_and_persistence.py#L511
 [13]: https://github.com/piotr-rusin/url-shortener/blob/2bbcb9bcc97f8226e7d90d201c57933421ee050e/url_shortener/models.py#L288
 [14]: https://github.com/piotr-rusin/url-shortener/blob/ee506ab166d3a170ee8790d33f20cf1ee88205a5/url_shortener/domain_and_persistence.py#L360
 [15]: https://github.com/piotr-rusin/url-shortener/blob/ee506ab166d3a170ee8790d33f20cf1ee88205a5/url_shortener/domain_and_persistence.py#L324
 [16]: https://github.com/piotr-rusin/url-shortener/blob/2bbcb9bcc97f8226e7d90d201c57933421ee050e/url_shortener/models.py#L226
 [17]: https://bitbucket.org/zzzeek/sqlalchemy/wiki/UsageRecipes/UniqueObject
 [18]: https://github.com/piotr-rusin/url-shortener/blob/ee506ab166d3a170ee8790d33f20cf1ee88205a5/url_shortener/domain_and_persistence.py#L400
 [19]: https://en.wikipedia.org/wiki/Homoglyph
 [20]: https://github.com/piotr-rusin/url-shortener/blob/2bbcb9bcc97f8226e7d90d201c57933421ee050e/url_shortener/views.py#L50
 [21]: https://github.com/piotr-rusin/url-shortener/blob/2bbcb9bcc97f8226e7d90d201c57933421ee050e/url_shortener/views.py#L96
 [22]: https://github.com/piotr-rusin/url-shortener/blob/2bbcb9bcc97f8226e7d90d201c57933421ee050e/url_shortener/views.py#L58
 [23]: https://github.com/piotr-rusin/url-shortener/blob/2bbcb9bcc97f8226e7d90d201c57933421ee050e/url_shortener/views.py#L83
 [24]: https://github.com/piotr-rusin/url-shortener/blob/ee506ab166d3a170ee8790d33f20cf1ee88205a5/url_shortener/views.py#L77
 [25]: https://github.com/miguelgrinberg/Flask-Migrate
 [26]: http://flask.pocoo.org/docs/0.11/blueprints/
 [27]: http://flask.pocoo.org/docs/0.11/patterns/appfactories/
 [28]: https://github.com/alecthomas/injector
 [29]: https://github.com/alecthomas/flask_injector
 [30]: http://stackoverflow.com/a/973567
 [31]: http://stackoverflow.com/a/31175306
 [32]: https://github.com/piotr-rusin/spam-lists
